<!DOCTYPE html>
<html>
<head>
  <title>Practica 04 - ‘Web Scraping’ con rvest</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <meta name="generator" content="pandoc" />




  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <base target="_blank">

  <script type="text/javascript">
    var SLIDE_CONFIG = {
      // Slide settings
      settings: {
                title: 'Practica 04 - ‘Web Scraping’ con <code>rvest</code>',
                        useBuilds: true,
        usePrettify: true,
        enableSlideAreas: true,
        enableTouch: true,
                        favIcon: 'Pract04_files/logo.svg',
              },

      // Author information
      presenters: [
            {
        name:  'Prof.: Pedro Albarrán' ,
        company: '',
        gplus: '',
        twitter: '',
        www: '',
        github: ''
      },
            {
        name:  'Prof.: Alberto Pérez' ,
        company: '',
        gplus: '',
        twitter: '',
        www: '',
        github: ''
      },
            ]
    };
  </script>

  <link href="site_libs/ioslides-13.5.1/fonts/fonts.css" rel="stylesheet" />
  <link href="site_libs/ioslides-13.5.1/theme/css/default.css" rel="stylesheet" />
  <link href="site_libs/ioslides-13.5.1/theme/css/phone.css" rel="stylesheet" />
  <script src="site_libs/ioslides-13.5.1/js/modernizr.custom.45394.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/prettify.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/lang-r.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/prettify/lang-yaml.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/hammer.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/slide-controller.js"></script>
  <script src="site_libs/ioslides-13.5.1/js/slide-deck.js"></script>

  <style type="text/css">

    b, strong {
      font-weight: bold;
    }

    em {
      font-style: italic;
    }

    summary {
      display: list-item;
    }

    slides > slide {
      -webkit-transition: all 0.4s ease-in-out;
      -moz-transition: all 0.4s ease-in-out;
      -o-transition: all 0.4s ease-in-out;
      transition: all 0.4s ease-in-out;
    }

    .auto-fadein {
      -webkit-transition: opacity 0.6s ease-in;
      -webkit-transition-delay: 0.4s;
      -moz-transition: opacity 0.6s ease-in 0.4s;
      -o-transition: opacity 0.6s ease-in 0.4s;
      transition: opacity 0.6s ease-in 0.4s;
      opacity: 0;
    }
/* https://github.com/ropensci/plotly/pull/524#issuecomment-468142578 */
slide:not(.current) .plotly.html-widget{
  display: block;
}

    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
            code.sourceCode > span { display: inline-block; line-height: 1.25; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode { white-space: pre; position: relative; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    code.sourceCode { white-space: pre-wrap; }
    code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
        
    slides > slide:not(.nobackground):before {
      font-size: 12pt;
      content: "";
      position: absolute;
      bottom: 20px;
      left: 60px;
      background: url(Pract04_files/logo.svg) no-repeat 0 50%;
      -webkit-background-size: 30px 30px;
      -moz-background-size: 30px 30px;
      -o-background-size: 30px 30px;
      background-size: 30px 30px;
      padding-left: 40px;
      height: 30px;
      line-height: 1.9;
    }
  </style>


</head>

<body style="opacity: 0">

<slides class="layout-widescreen">

  <slide class="title-slide segue nobackground">
        <aside class="gdbar"><img src="Pract04_files/logo.svg"></aside>
        <!-- The content of this hgroup is replaced programmatically through the slide_config.json. -->
    <hgroup class="auto-fadein">
      <h1 data-config-title><!-- populated from slide_config.json --></h1>
      
      <p data-config-presenter><!-- populated from slide_config.json --></p>
            <p style="margin-top: 6px; margin-left: -2px;">Universidad de Alicante, Curso 2020/21</p>
          </hgroup>
  </slide>

<slide class=""><hgroup><h2><em>Scraping</em> con <code>rvest</code></h2></hgroup><article  id="scraping-con-rvest">

<p>Internet es un gran lugar para obtener datos. Podemos usar <code>rvest</code> para extraer (en inglés, <em>scrap</em> significa literalmente raspar o rascar una superficie) los datos en tablas HTML de la web, pero a menudo requerirá una limpieza extensa antes de que se puedan usar adecuadamente.</p>

<p>Considerar la siguiente lista de los fines de semana de apertura de taquillas más grandes:</p>

<p>(<a href='http://www.boxofficemojo.com/alltime/weekends/' title=''>http://www.boxofficemojo.com/alltime/weekends/</a>)</p>

<p>Usando <code>rvest</code> podemos traer esta tabla a R.</p>

<pre class = 'prettyprint lang-r'>library(rvest)
url &lt;- &quot;http://www.boxofficemojo.com/alltime/weekends/&quot;</pre>

<p>Primero, necesitaremos leer el contenido de la página en HTML. La función <code>read_html()</code> proporcionada por <code>rvest</code> procesa el HTML:</p>

<pre class = 'prettyprint lang-r'>html_bom &lt;- read_html(url)
class(html_bom)
html_bom</pre>

<p>Desafortunadamente, esto no es muy legible. Lo que queremos es extraer los datos que están incrustados en las tablas HTML. Empecemos por tomar esas tablas que están dentro de los elementos del html llamados &ldquo;table&rdquo;. Para ello podemos utilizar <code>html_nodes()</code>:</p>

<pre class = 'prettyprint lang-r'>tables &lt;- html_bom %&gt;%
  html_nodes(&quot;table&quot;)
tables</pre>

<!--
En este caso, había 6 elementos de tabla en esa página (la mayoría de ellos usados para crear los bordes). Sólo nos interesa el grande con todos los datos. Este es el quinto elemento de la lista (nota: averiguadpo por prueba y error).

```r
tables[[5]]
```
-->

<p>En este caso, solo hay 1 elementos de tabla en esa página .</p>

<pre class = 'prettyprint lang-r'>tables[[1]]</pre>

<p>La función <code>html_table()</code> extraerá los datos de esta tabla y los convertirá en un <em>data frame</em>. La opción <code>header = TRUE</code> indica a R que queremos usar la primera fila como nuestros nombres de variable.</p>

<pre class = 'prettyprint lang-r'>movies &lt;- tables[[1]] %&gt;%
  html_table(header = TRUE)
glimpse(movies)</pre>

<p>En algunas ocasiones, existen más de una table en una página web. Si son pocas se puede determinar cuál nos interesa mediante prueba y error. En particular, en esta caso sabemos que los datos tienen 200 observaciones y 9 columnas; si lo que leemos tiene una dimensiones (obtenidas con <code>glimpse()</code> o <code>str()</code>) muy diferentes no debe ser la tabla que buscamos. En cualquier caso, con muchas tablas en la página web, necesitaremos nuevas herramientas de programación que veremos en breve.</p>

<!--
En este caso sólo teníamos 6 tablas, así que no fue demasiado difícil usar prueba y error para averiguar cuál era la que queríamos. Pero también podríamos ser un poco más sistemáticos.

Usemos `lapply()` para extraer las 6 tablas, en un objeto de tipo lista con una longitud de 6:

```r
list_of_tables <- lapply(tables, html_table, fill = TRUE)
class(list_of_tables)
length(list_of_tables)
str(list_of_tables)
```

Puesto que `html_table()` asigna las tablas HTML a *data frames* en R, cada uno de los seis elementos de la lista list_of_tables es un *data frame*. Sin embargo, algunas de las tablas son más grandes que otras.


```r
lapply(list_of_tables, class)
lapply(list_of_tables, dim)
```

Es obvio desde la propia página web que la tabla que queremos tiene 9 variables y 214 filas. Sólo (el quinto elemento)[http://www.imdb.com/title/tt0119116/] de nuestra lista cumple con ese criterio.
-->

</article></slide><slide class=""><hgroup><h2>Limpieza de datos</h2></hgroup><article  id="limpieza-de-datos">

<p>Si bien ahora tenemos los datos, podemos ver que son muy confusos:</p>

<ul>
<li><p>los nombres de las variables contienen caracteres especiales, como asteriscos, paréntesis y espacios. Esto puede causar problemas, así que queremos cambiarlos.</p></li>
<li><p>la mayoría de las columnas se almacenan como vectores de caracteres, aunque contienen información cuantitativa. En particular, hay columnas para dólares, porcentajes y fechas que están en el formato equivocado.</p></li>
</ul>

<p>Debido a este desajuste, si intentamos dibujar los datos, esto no funcionará como se esperaba.</p>

<pre class = 'prettyprint lang-r'>ggplot(
  data = movies, 
  aes(x = Date, y = Opening)
) + 
  geom_point(aes(size = `% of Total`))</pre>

<p>Nota que cuando los nombres de la variables tienen caracteres &ldquo;raros&rdquo; se debe utilizar ` para marcar el inicio y el final del nombre. Esto incluye cualquier caracter no alfanumerico en cualquier posición del nombre de la variable y también los números al comienzo del nombre de una variable. Aquí esto sucede tanto por símbolo % como por el espacio. Otros caracteres no alfanumericos son cualquier simbolo de puntuación, barras o letras como la ñ.</p>

<p>La función <code>parse_number()</code> del paquete <code>readr</code> es extremadamente útil para limpiar signos de dólar, comas y signos de porcentaje en los valores (Ojo, esto es diferente de los caracteres raros en el nombre mencionado antes). Usaremos esto en conjunción con el verbo <code>mutate()</code> para renombrar las columnas al mismo tiempo.</p>

<pre class = 'prettyprint lang-r'>library(readr)
movies &lt;- movies %&gt;%
  mutate(opening = parse_number(Opening),
         percent_total = parse_number(`% of Total`)/100)
glimpse(movies)</pre>

<p>Ahora, cuando dibujamos los datos cuantitativos, obtenemos algo que tiene más sentido.</p>

<pre class = 'prettyprint lang-r'>ggplot(data = movies, aes(x = Date, y = opening)) + 
  geom_point(aes(size = percent_total))</pre>

<h3>Ejercicio</h3>

<p>También crear una nueva variable llamada <code>num_theaters</code> que almacena el número de teatros como un entero, y otras dos más con el promedio y el total recaudado. Responde <a href='https://docs.google.com/forms/d/e/1FAIpQLScJhX5F219jttLOAReSpiT5Mg7aO7-clheg2170DFsprTTp5A/viewform' title=''>aquí</a></p>

<p>Notad que es conveniente usar el tipo de datos enteros cuando estamos seguro de que la variable contiene ese tipo de valores porque se ahorra espacion de almacenamiento. Sin embargo, hay ciertos &ldquo;límites&rdquo; a los valores que se pueden representar como enteros: ver <code>help(integer)</code>.</p>

</article></slide><slide class=""><hgroup><h2>Fechas con <code>lubridate</code></h2></hgroup><article  id="fechas-con-lubridate">

<p>Desafortunadamente, las fechas siguen siendo un problema. Echemos un vistazo a esas fechas:</p>

<pre class = 'prettyprint lang-r'>movies %&gt;%
  select(Date) %&gt;%
  glimpse()</pre>

<p>Vemos que las fechas están en formato mes/día/año. Ya hemos visto anterioreme el paquete <code>lubridate</code> que proporciona funcionalidad para trabajar con fechas. Podemos utilizar la función <code>mdy()</code> para convertir el vector de caracteres en una clase de fecha.</p>

<pre class = 'prettyprint lang-r'>library(lubridate)
movies &lt;- movies %&gt;%
  mutate(release_date = mdy(Date))
glimpse(movies)</pre>

<pre class = 'prettyprint lang-r'>ggplot(data = movies, aes(x = release_date, y = opening)) + 
  #queremos un gráfico de dispersión, y usaremos tanto el color como el tamaño para mostrar porcentaje total
  geom_point(aes(color = percent_total, size = percent_total)) +
  # truco para combinar color y tamaño en una sola leyenda 
  guides(color = guide_legend(&quot;Porcentaje Total&quot;), 
         size = guide_legend(&quot;Porcentaje Total&quot;)) +
  # Formatear el eje y para mostrar la cantidad en $.
  scale_y_continuous(name = &quot;Recaudación en el Día de Apertura&quot;, labels = scales::dollar) +
  # etiquetamos tambien el ejer de las x (podemos omitir el argumento `name`)
  scale_x_date(&quot;Fecha de estreno&quot;)</pre>

<h3>Mini-Práctica</h3>

<ol>
<li><p>Repetir el ejercicio con la siguiente fuente de información: <a href='http://www.the-numbers.com/movie/records/Biggest-Opening-Weekend-at-the-Box-Office' title=''>http://www.the-numbers.com/movie/records/Biggest-Opening-Weekend-at-the-Box-Office</a>. Es decir, debéis extraer los datos relevantes de la web, limpiarlos y dejarlos preparados para trabajar; también realizar un gráfico (a vuestra elección) similar al anterior.</p>

<p>Debéis enviar un archivo de guión .R respondiendo a <a href='https://docs.google.com/forms/d/e/1FAIpQLSfl1vrJhI_fXjbkLv_OJxgJezCycNC_PF-tiUMfnuAepx_NGA/viewform' title=''>este formulario</a>. Como es habitual, el nombre del archivo debe empezar con vuestro número de DNI (el resto es libre): ej., 12345678_P04.R.</p></li>
</ol>

<!--
    a. Extraer los datos relevantes de la web, limpiar/transformar los datos en brutos y dejarlos "cargados" para su posterior análisis. Este es un ejemplo "simple" de lo que se conoce como [ETL](https://es.wikipedia.org/wiki/Extract,_transform_and_load). 
    b. Realizar un gráfico (a vuestra elección) similar al anterior.\newline\newline
    
    Debéis enviar un archivo de guión .R respondiendo a [este formulario](https://docs.google.com/forms/d/e/1FAIpQLSfl1vrJhI_fXjbkLv_OJxgJezCycNC_PF-tiUMfnuAepx_NGA/viewform). Como es habitual, el nombre del archivo debe empezar con vuestro número de DNI (el resto es libre): ej., 12345678_P04.R.
-->

<ol>
<li><p>Partiendo de la tabla de datos obtenida en el apartado 1, realizar un BREVE análisis exploratorio de los datos siguiendo las pautas generales<a id="fnref1" href="#fn1"><sup>1</sup></a> vistas en la Práctica 03 de la asignatura.</p>

<p>Debéis enviar un archivo de R Markdown y el resultado de renderizarlo (en .html, .docx o .pdf, a vuestra elección) respondiendo a <a href='https://docs.google.com/forms/d/e/1FAIpQLSfcYTZtomecawRE2lt1Dclm_r4zIoBwG0Gxn0C1uKhsf3NA-g/viewform' title=''>este formulario</a>. Como es habitual, los nombres de los archivos debe empezar con vuestro número de DNI (el resto es libre): ej., 12345678_P04.Rmd y 12345678_P04.html.</p>

<p>NOTA: no os compliquéis mucho: hay pocas variables (podéis querer generar alguna) y no hay mucha información para extraer &ldquo;grandes&rdquo; conclusiones. Centraros en practicar lo que se discutió en la práctica, describiendo la variación de (algunas) las variables y de las posibles relaciones entre ellas que consideréis más relevantes.</p></li>
</ol></article></slide>


  <slide class="backdrop"></slide>

</slides>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

<!-- map slide visiblity events into shiny -->
<script>
  (function() {
    if (window.jQuery) {
       window.jQuery(document).on('slideleave', function(e) {
         window.jQuery(e.target).trigger('hidden');
      });
       window.jQuery(document).on('slideenter', function(e) {
         window.jQuery(e.target).trigger('shown');
      });
    }
  })();
</script>

</body>
</html>
